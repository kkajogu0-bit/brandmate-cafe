<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>BrandMate Pro (Single File)</title>
  <style>
    :root{--bg:#0b0f15;--card:#131a22;--muted:#9fb0c0;--ok:#34d399;--warn:#f59e0b;--err:#ef4444;--white:#fff}
    *{box-sizing:border-box}body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Noto Sans KR;background:var(--bg);color:var(--white)}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}.card{background:#131a22;border:1px solid #1f2937;border-radius:16px;padding:20px}
    .grid{display:grid;gap:16px}.grid.c2{grid-template-columns:repeat(2,minmax(0,1fr))}.grid.c3{grid-template-columns:repeat(3,minmax(0,1fr))}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3746;background:#0e141b;color:#e5e7eb}
    input[type=color]{padding:0;height:40px}button{cursor:pointer;background:linear-gradient(180deg,#1d4ed8,#1e40af);border:none;font-weight:700}
    button.secondary{background:#0e141b;border:1px solid #334155}.row{display:flex;gap:10px;flex-wrap:wrap}
    .tabbar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}.tabbar button{flex:1;min-width:180px}
    .muted{color:var(--muted);font-size:13px}.success{color:var(--ok)}.warn{color:var(--warn)}.error{color:var(--err)}.hidden{display:none}
    .preview{background:#0e141b;border:1px dashed #334155;padding:16px;border-radius:12px}.brand{background:#0b1320;padding:20px;border-radius:14px}
    .palette{display:flex;gap:8px}.sw{width:28px;height:28px;border-radius:8px;border:1px solid #334155}.sep{height:1px;background:#263042;margin:16px 0}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #334155;font-size:12px}
  </style>
  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
<div class="wrap">

  <!-- LOGIN -->
  <div id="gate" class="card">
    <h1>ğŸ”’ BrandMate Pro â€” ë¡œê·¸ì¸</h1>
    <p class="muted">ë°ëª¨ ëª¨ë“œë¡œ ëª¨ë“  ê¸°ëŠ¥ ì²´í—˜ ê°€ëŠ¥. ì‹¤ì‚¬ìš©ì€ ë¼ì´ì„ ìŠ¤ í•„ìš”.</p>
    <div class="grid c2">
      <div><label>ì´ë©”ì¼</label><input id="email" placeholder="you@example.com"></div>
      <div><label>ë¼ì´ì„ ìŠ¤ í‚¤</label><input id="license" placeholder="XXXX-XXXX-XXXX"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnLogin">ì ê¸ˆ í•´ì œ</button>
      <button class="secondary" id="btnDemo">ë°ëª¨ ëª¨ë“œ</button>
    </div>
    <div id="gateMsg" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <div class="card" style="margin-top:16px">
      <div class="tabbar">
        <button id="tabBrand">â‘  ë¸Œëœë“œ ë³´ë“œ</button>
        <button id="tabBanners">â‘¡ ë°°ë„ˆ ìƒì„±</button>
        <button id="tabCaptions">â‘¢ ìº¡ì…˜/ì˜¤í¼</button>
        <button id="tabAB">â‘£ A/B CSV</button>
        <button id="tabCalendar">â‘¤ í¬ìŠ¤íŒ… ìº˜ë¦°ë”</button>
        <button id="tabAudit">â‘¥ í’ˆì§ˆ ì ê²€</button>
      </div>

      <!-- BRAND -->
      <section id="panelBrand">
        <div class="grid c2">
          <div>
            <div class="row">
              <div style="flex:1">
                <label>ë¸Œëœë“œëª…</label><input id="b_name" placeholder="ì˜ˆ: BLUE BEAN CAFE">
              </div>
              <div style="flex:1">
                <label>ì‚°ì—… í”„ë¦¬ì…‹</label>
                <select id="preset">
                  <option value="">ì„ íƒ</option>
                  <option value="cafe">ì¹´í˜</option>
                  <option value="academy">í•™ì›</option>
                  <option value="handmade">í•¸ë“œë©”ì´ë“œ</option>
                </select>
              </div>
            </div>
            <label>ìŠ¬ë¡œê±´</label><input id="b_slogan" placeholder="í•œ ì”ì˜ ì§‘ì¤‘ì„ ë‚´ì¼ë¡œ">
            <label>í†¤/í‚¤ì›Œë“œ(ì‰¼í‘œ)</label><input id="b_tone" placeholder="í•™ìƒ, ì§‘ì¤‘, ë¯¸ë‹ˆë©€, ì‹ ë¢°">
            <div class="grid c2">
              <div><label>ê¸°ë³¸ ìƒ‰ìƒ</label><input type="color" id="b_c1" value="#2663eb"></div>
              <div><label>ë³´ì¡° ìƒ‰ìƒ</label><input type="color" id="b_c2" value="#14b8a6"></div>
            </div>
            <label>í°íŠ¸</label>
            <select id="b_font">
              <option value="Inter, system-ui, sans-serif">Inter</option>
              <option value="Noto Sans KR, system-ui">Noto Sans KR</option>
              <option value="Roboto, system-ui, sans-serif">Roboto</option>
              <option value="Segoe UI, Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
            </select>
            <label>ëŸ°ì¹­ ì¼ì •</label><input id="b_launch" placeholder="YYYY-MM-DD">
            <div class="row" style="margin-top:10px">
              <button id="btnPreviewBoard">ë¯¸ë¦¬ë³´ê¸°</button>
              <button class="secondary" id="btnPDF">PDF ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <div id="contrastMsg" class="muted" style="margin-top:8px"></div>
          </div>
          <div class="preview">
            <div class="row" style="justify-content:space-between;align-items:center">
              <h3>ë¯¸ë¦¬ë³´ê¸° <span id="planBadge" class="pill">Lite</span></h3>
            </div>
            <div id="boardPreview" class="brand">
              <div id="bp_brand" style="font-size:28px;font-weight:800">BRAND</div>
              <div id="bp_slogan" class="muted">Slogan goes here</div>
              <div class="sep"></div>
              <div class="palette">
                <div id="sw1" class="sw"></div><div id="sw2" class="sw"></div>
                <div id="sw3" class="sw"></div><div id="sw4" class="sw"></div>
              </div>
              <div class="sep"></div>
              <div class="muted">í†¤: <span id="bp_tone">ë¯¸ë‹ˆë©€, ì‹ ë¢°</span></div>
              <div class="muted">í°íŠ¸: <span id="bp_font">Inter</span></div>
              <div class="muted">ëŸ°ì¹­: <span id="bp_launch">-</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- BANNERS -->
      <section id="panelBanners" class="hidden">
        <div class="grid c2">
          <div>
            <label>ë¬¸êµ¬(í° ì œëª©)</label><input id="bn_title" placeholder="ì˜¤ëŠ˜ì˜ ì‹œê·¸ë‹ˆì²˜ 20% OFF">
            <label>ë³´ì¡° ë¬¸êµ¬</label><input id="bn_sub" placeholder="ì‹œí—˜ê¸°ê°„ ì§‘ì¤‘ í”„ë¡œëª¨ì…˜">
            <div class="grid c3">
              <div><label>ê¸°ë³¸ ìƒ‰ìƒ</label><input type="color" id="bn_c1" value="#2663eb"></div>
              <div><label>ë³´ì¡° ìƒ‰ìƒ</label><input type="color" id="bn_c2" value="#14b8a6"></div>
              <div><label>í…ìŠ¤íŠ¸ ìƒ‰</label><input type="color" id="bn_tx" value="#ffffff"></div>
            </div>
            <div class="grid c3">
              <div>
                <label>QR ëª©ì ì§€</label>
                <select id="qr_type">
                  <option value="custom">ì§ì ‘ ì…ë ¥</option>
                  <option value="smartstore">ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´</option>
                  <option value="naverform">ë„¤ì´ë²„ í¼</option>
                  <option value="kakao">ì¹´í†¡ ì˜¤í”ˆì±„íŒ…</option>
                </select>
              </div>
              <div><label>ê¸°ë³¸ URL/ì½”ë“œ</label><input id="qr_base" placeholder="https://... ë˜ëŠ” ì½”ë“œ"></div>
              <div><label>ìº í˜ì¸(UTM)</label><input id="qr_campaign" placeholder="september_promo"></div>
            </div>
            <div class="grid c3">
              <div><label>ì›Œí„°ë§ˆí¬</label><input id="bn_wm" placeholder="@yourbrand"></div>
              <div><label>ì›Œí„°ë§ˆí¬ í‘œì‹œ</label><select id="bn_wm_on"><option value="on" selected>On</option><option value="off">Off</option></select></div>
              <div><label>ì˜¤í¼ ë°°ì§€</label>
                <select id="offer_badge"><option value="">(ì—†ìŒ)</option><option>1+1</option><option>20% OFF</option><option>ì„ ë“±ë¡ 5%</option><option>ì„¸íŠ¸ 10%</option></select>
              </div>
            </div>
            <div class="grid c3">
              <div><label><input type="checkbox" id="size_sq" checked> 1080Ã—1080</label></div>
              <div><label><input type="checkbox" id="size_por" checked> 1080Ã—1350</label></div>
              <div><label><input type="checkbox" id="size_hd" checked> 1920Ã—1080</label></div>
            </div>
            <div class="grid c3">
              <div><label>ìë™ ëŒ€ë¹„ ë³´ì •</label><select id="auto_contrast"><option value="on" selected>On</option><option value="off">Off</option></select></div>
              <div><label>ì„¸ì´í”„ ë§ˆì§„</label><select id="safe_overlay"><option value="on">On</option><option value="off" selected>Off</option></select></div>
              <div><label>í…ìŠ¤íŠ¸ ë°°ê²½</label><select id="text_bg"><option value="auto" selected>ìë™</option><option value="off">Off</option></select></div>
            </div>
            <div class="row" style="margin-top:10px">
              <button id="btnGenBanners">ë°°ë„ˆ ZIP</button>
              <button class="secondary" id="btnBuildQR">QR URL ìƒì„±</button>
            </div>
            <div id="qrFinal" class="muted" style="margin-top:4px"></div>
          </div>
          <div>
            <canvas id="cnv" width="540" height="540" style="width:100%;background:#0b1320;border-radius:12px"></canvas>
            <div id="bnContrastMsg" class="muted" style="margin-top:8px"></div>
          </div>
        </div>
      </section>

      <!-- CAPTIONS -->
      <section id="panelCaptions" class="hidden">
        <div class="grid c2">
          <div>
            <label>í‚¤ì›Œë“œ(ì‰¼í‘œ)</label><input id="cp_kw" placeholder="ì•„ë©”ë¦¬ì¹´ë…¸, ì§‘ì¤‘, ì‹œí—˜ê¸°ê°„, ì¹´í˜">
            <label>í†¤</label>
            <select id="cp_tone">
              <option value="friendly">ì¹œê·¼í•¨</option>
              <option value="minimal">ë¯¸ë‹ˆë©€</option>
              <option value="energetic">ì—ë„ˆì§€</option>
            </select>
            <div class="row" style="margin-top:10px">
              <button id="btnGenCaps">ìº¡ì…˜ 5ê°œ</button>
              <button class="secondary" id="btnCopyCaps">ë³µì‚¬</button>
            </div>
            <div class="sep"></div>
            <label>ì˜¤í¼ ì•„ì´ë””ì–´(ì—…ì¢…ë³„)</label>
            <div class="row">
              <select id="offer_preset"><option value="cafe">ì¹´í˜</option><option value="academy">í•™ì›</option><option value="handmade">í•¸ë“œë©”ì´ë“œ</option></select>
              <button class="secondary" id="btnOffers">5ê°œ ë½‘ê¸°</button>
            </div>
          </div>
          <div>
            <label>ê²°ê³¼</label>
            <textarea id="cp_out" rows="16" placeholder="ì—¬ê¸°ì— ìº¡ì…˜/ì˜¤í¼ê°€ ìƒì„±ë©ë‹ˆë‹¤."></textarea>
          </div>
        </div>
      </section>

      <!-- A/B -->
      <section id="panelAB" class="hidden">
        <div class="grid c2">
          <div>
            <label>ìº í˜ì¸ ì´ë¦„</label><input id="ab_name" placeholder="9ì›” ì‹œí—˜ê¸°ê°„ í”„ë¡œëª¨ì…˜">
            <label>ë²„ì „ A</label><input id="ab_a" placeholder="ë²„ì „ A í…ìŠ¤íŠ¸">
            <label>ë²„ì „ B</label><input id="ab_b" placeholder="ë²„ì „ B í…ìŠ¤íŠ¸">
            <div class="row" style="margin-top:10px"><button id="btnCSV">CSV ë‚´ë³´ë‚´ê¸°</button></div>
          </div>
          <div class="muted">CSV ì»¬ëŸ¼: date,campaign,version,caption,clicks,impressions,ctr,conversions</div>
        </div>
      </section>

      <!-- CALENDAR -->
      <section id="panelCalendar" class="hidden">
        <div class="grid c2">
          <div>
            <label>ì‹œì‘ì¼</label><input id="cal_start" placeholder="YYYY-MM-DD">
            <label>ë¹ˆë„</label><select id="cal_freq"><option value="3x">ì£¼ 3íšŒ(ì›”/ìˆ˜/ê¸ˆ)</option><option value="2x">ì£¼ 2íšŒ(í™”/ëª©)</option><option value="daily">ë§¤ì¼</option></select>
            <label>ê¸°ê°„(ì¼)</label><input id="cal_days" value="7">
            <label>ì‹œê°„ëŒ€</label><select id="cal_time"><option>09:00</option><option>18:00</option></select>
            <label>í”Œë«í¼</label><select id="cal_platform"><option>instagram</option><option>smartstore</option><option>youtube</option></select>
            <div class="row" style="margin-top:10px"><button id="btnCalCSV">ìº˜ë¦°ë” CSV</button></div>
          </div>
          <div class="muted">ì˜ˆì•½ ê²Œì‹œìš© CSV ìƒì„± (date,time,platform,caption)</div>
        </div>
      </section>

      <!-- AUDIT -->
      <section id="panelAudit" class="hidden">
        <div class="grid c2">
          <div>
            <h3>í’ˆì§ˆ ì ê²€</h3>
            <div>ëŒ€ë¹„ 4.5+ : <b id="audit_contrast">-</b></div>
            <div>ì˜¤í†  ì‚¬ì´ì¦ˆ : <b>OK</b></div>
            <div>ì„¸ì´í”„ ë§ˆì§„ 6% : <b>OK</b></div>
            <div>ì›Œí„°ë§ˆí¬ : <b id="audit_wm">-</b></div>
            <div>QR(UTM) : <b id="audit_qr">-</b></div>
            <div>ì˜¤í¼ í¬í•¨ : <b id="audit_offer">-</b></div>
            <div>ìº˜ë¦°ë” : <b id="audit_cal">-</b></div>
            <div class="row" style="margin-top:10px"><button class="secondary" id="btnAuditNow">ì§€ê¸ˆ ì ê²€</button></div>
          </div>
          <div class="muted">ëª¨ë“  ì§€í‘œê°€ OKê°€ ë˜ë©´ í€„ë¦¬í‹° ê¸°ì¤€ ì¶©ì¡±ì…ë‹ˆë‹¤.</div>
        </div>
      </section>

    </div>
  </div>
</div>

<script>
// ===== CONFIG (ë°°í¬ ì „ ë³€ê²½) =====
const LICENSES_URL = "https://raw.githubusercontent.com/<your-github-username>/<your-repo>/main/licenses.json";
const SALT = "CHANGE_ME_SALT_2025";

// ===== Helpers =====
const $=id=>document.getElementById(id);
function fmtDate(d){return d.toISOString().slice(0,10);}
async function sha256(s){const b=new TextEncoder().encode(s);const h=await crypto.subtle.digest('SHA-256',b);return Array.from(new Uint8Array(h)).map(x=>x.toString(16).padStart(2,'0')).join('');}
async function checkLicense(email,key){
  try{
    const r=await fetch(LICENSES_URL,{cache:'no-store'}); if(!r.ok) throw 0;
    const arr=await r.json(); const dig=await sha256(`${email}:${key}:${SALT}`); const today=fmtDate(new Date());
    return arr.find(x=>x.hash===dig && (!x.expires||x.expires>=today))||null;
  }catch(e){return null}
}
function show(id){$(id).classList.remove('hidden')}function hide(id){$(id).classList.add('hidden')}
function hexToRgb(h){h=h.replace('#','');if(h.length===3)h=[h[0]+h[0],h[1]+h[1],h[2]+h[2]].join('');const n=parseInt(h,16);return{r:(n>>16)&255,g:(n>>8)&255,b:n&255}}
function shade(h,a){const{r,g,b}=hexToRgb(h);const f=x=>Math.max(0,Math.min(255,Math.round(x+(255-x)*a)));return '#'+[f(r),f(g),f(b)].map(x=>x.toString(16).padStart(2,'0')).join('')}
function relL(h){const{r,g,b}=hexToRgb(h);const L=c=>{c/=255;return c<=0.03928?c/12.92:Math.pow((c+0.055)/1.055,2.4)};return 0.2126*L(r)+0.7152*L(g)+0.0722*L(b)}
function contrast(a,b){const A=relL(a),B=relL(b),hi=Math.max(A,B)+0.05,lo=Math.min(A,B)+0.05;return hi/lo}
function wrapText(ctx,t,x,y,maxW,lH){const w=t.split(' ');let line='';for(let i=0;i<w.length;i++){const test=line+w[i]+' ';if(ctx.measureText(test).width>maxW&&i>0){ctx.fillText(line,x,y);line=w[i]+' ';y+=lH}else line=test}ctx.fillText(line,x,y)}
function autosize(ctx,t,maxW,maxF,minF,wt){let s=maxF;while(s>minF){ctx.font=`${wt} ${s}px Inter, Arial`;if(ctx.measureText(t).width<=maxW)return s;s-=2}return minF}

// ===== Gate =====
function setPlan(){const p=localStorage.getItem('bm_plan')||'lite';const el=$('planBadge');el.textContent=p.toUpperCase();el.style.borderColor=p==='pro'?'#34d399':'#334155'}
$('btnLogin').onclick=async()=>{const email=$('email').value.trim(),key=$('license').value.trim();$('gateMsg').textContent='ê²€ì¦ ì¤‘...';const lic=await checkLicense(email,key);if(lic){localStorage.setItem('bm_plan',lic.plan||'lite');$('gateMsg').innerHTML='<span class="success">ì¸ì¦ ì„±ê³µ!</span>';setTimeout(()=>{hide('gate');show('app');setPlan()},300)}else{$('gateMsg').innerHTML='<span class="error">ì¸ì¦ ì‹¤íŒ¨</span>'}}
$('btnDemo').onclick=()=>{localStorage.setItem('bm_plan','pro');hide('gate');show('app');setPlan()}

// ===== Brand =====
const PRESETS={cafe:{name:"BLUE BEAN CAFE",slogan:"í•œ ì”ì˜ ì§‘ì¤‘ì„ ë‚´ì¼ë¡œ",tone:"í•™ìƒ, ì§‘ì¤‘, ë¯¸ë‹ˆë©€, ì‹ ë¢°",c1:"#0ea5e9",c2:"#22c55e",font:"Inter, system-ui, sans-serif"},
               academy:{name:"SEONGSIK ACADEMY",slogan:"í•œ ë¬¸ì œì”© í™•ì‹¤í•˜ê²Œ",tone:"ì‹ ë¢°, ì •ì§, ì„±ì‹¤, ê²°ê³¼",c1:"#1d4ed8",c2:"#f59e0b",font:"Noto Sans KR, system-ui"},
               handmade:{name:"KIRING STUDIO",slogan:"ì˜¤ëŠ˜ í•œ í†¤ì˜ ë¯¸ì†Œ",tone:"ê°ì„±, í¬ê·¼, ìºë¦­í„°, í•™ìƒ",c1:"#ef4444",c2:"#f97316",font:"Segoe UI, Tahoma, Geneva, Verdana, sans-serif"}};
function updatePreview(){
  const name=$('b_name').value||'BRAND',slogan=$('b_slogan').value||'Slogan goes here',tone=$('b_tone').value||'ë¯¸ë‹ˆë©€, ì‹ ë¢°',c1=$('b_c1').value,c2=$('b_c2').value,font=$('b_font').value,launch=$('b_launch').value||'-';
  $('boardPreview').style.fontFamily=font;$('bp_brand').textContent=name;$('bp_slogan').textContent=slogan;$('bp_tone').textContent=tone;$('bp_font').textContent=font.split(',')[0];$('bp_launch').textContent=launch;
  $('boardPreview').style.border='1px solid '+c1;$('sw1').style.background=c1;$('sw2').style.background=c2;$('sw3').style.background=shade(c1,-0.2);$('sw4').style.background=shade(c2,-0.2);
  const crW=contrast(c1,'#ffffff').toFixed(2),crB=contrast(c1,'#000000').toFixed(2);const cls=v=>v>=4.5?'success':(v>=3?'warn':'error');
  $('contrastMsg').innerHTML=`ëŒ€ë¹„: í°ìƒ‰ <b class="${cls(crW)}">${crW}</b> / ê²€ì • <b class="${cls(crB)}">${crB}</b> (ê¶Œì¥ â‰¥ 4.5)`;
}
$('btnPreviewBoard').onclick=updatePreview;
$('preset').onchange=()=>{const p=PRESETS[$('preset').value];if(!p)return;$('b_name').value=p.name;$('b_slogan').value=p.slogan;$('b_tone').value=p.tone;$('b_c1').value=p.c1;$('b_c2').value=p.c2;$('b_font').value=p.font;updatePreview();}
$('btnPDF').onclick=async()=>{const n=$('boardPreview');const c=await html2canvas(n,{scale:2,backgroundColor:'#0b1320'});const img=c.toDataURL('image/png');const{jsPDF}=window.jspdf;const pdf=new jsPDF({unit:'pt',format:'a4',compress:true});const w=pdf.internal.pageSize.getWidth();const h=(c.height/c.width)*w;pdf.addImage(img,'PNG',20,20,w-40,h-40);pdf.save('brand-board.pdf')}

// ===== Banners =====
function buildQR(){const type=$('qr_type').value,base=$('qr_base').value.trim(),camp=$('qr_campaign').value.trim()||'campaign';let url='';if(type==='custom')url=base; if(type==='smartstore')url=`https://smartstore.naver.com/${base}`; if(type==='naverform')url=base.startsWith('http')?base:`https://naver.me/${base}`; if(type==='kakao')url=base; if(url){const g=url.includes('?')?'&':'?';url=`${url}${g}utm_source=brandmate&utm_medium=banner&utm_campaign=${encodeURIComponent(camp)}`}$('qrFinal').textContent=url?`ìµœì¢… QR URL: ${url}`:'QR URLì„ ì…ë ¥í•˜ì„¸ìš”.';$('qrFinal').dataset.url=url||'';return url||''}
$('btnBuildQR').onclick=buildQR;

function drawPill(ctx,text,x,y,padX,padY,bg,tx){ctx.font=`700 ${Math.round(ctx.canvas.width*0.03)}px Inter, Arial`;const tw=ctx.measureText(text).width;const w=tw+padX*2,h=Math.round(ctx.canvas.width*0.06)+padY*2;const r=h/2;ctx.fillStyle=bg;ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();ctx.fill();ctx.fillStyle=tx;ctx.fillText(text,x+padX,y+h-padY*1.2)}
function drawBanner(ctx,w,h,title,sub,c1,c2,tx,variant,qrUrl,wm,wmOn,autoContrastOn,safeOverlay,textBg,offerBadge){
  const grad=ctx.createLinearGradient(0,0,w,h);grad.addColorStop(0,c1);grad.addColorStop(1,variant%2?shade(c2,-0.15):c2);ctx.fillStyle=grad;ctx.fillRect(0,0,w,h);
  ctx.globalAlpha=.08;for(let i=0;i<6;i++){ctx.fillStyle=i%2?'#fff':'#000';const r=60+Math.random()*120;ctx.beginPath();ctx.arc(Math.random()*w,Math.random()*h,r,0,Math.PI*2);ctx.fill()}ctx.globalAlpha=1;
  const pad=Math.round(w*.06),maxW=w-pad*2;const cr=contrast(c1,tx);
  if(autoContrastOn&&cr<4.5){const cw=contrast(c1,'#fff'),cb=contrast(c1,'#000');tx=cw>=cb?'#fff':'#000'}
  let titleY=Math.round(h*.38);if(textBg==='auto'){ctx.fillStyle='rgba(0,0,0,.25)';ctx.fillRect(pad,titleY-Math.round(w*.10),maxW,Math.round(w*.15))}
  let sT=autosize(ctx,title,maxW,Math.round(w*.09),Math.round(w*.05),'bold');ctx.font=`bold ${sT}px Inter, Arial`;ctx.fillStyle=tx;wrapText(ctx,title,pad,titleY,maxW,Math.round(sT*1.1));
  let sS=autosize(ctx,sub,maxW,Math.round(w*.045),Math.round(w*.03),'500');if(textBg==='auto'){ctx.fillStyle='rgba(0,0,0,.25)';ctx.fillRect(pad,h-pad*2-Math.round(sS*1.2),maxW,Math.round(sS*2.2))}ctx.font=`500 ${sS}px Inter, Arial`;ctx.fillStyle=tx;wrapText(ctx,sub,pad,h-pad*2,maxW,Math.round(sS*1.2));
  if(offerBadge){const bg=shade(c2,-0.2);const tcol=contrast(bg,'#fff')>=4.5?'#fff':'#000';drawPill(ctx,offerBadge,pad,pad,Math.round(w*.02),Math.round(w*.01),bg,tcol)}
  if(qrUrl){const s=Math.round(w*.18);const qc=document.createElement('canvas');QRCode.toCanvas(qc,qrUrl,{width:s,margin:0});ctx.drawImage(qc,w-pad-s,h-pad-s,s,s)}
  if(wmOn&&wm){ctx.globalAlpha=.75;ctx.font=`600 ${Math.round(w*.03)}px Inter, Arial`;const tw=ctx.measureText(wm).width;ctx.fillStyle=tx;ctx.fillText(wm,w-pad-tw,pad+Math.round(w*.03));ctx.globalAlpha=1}
  if(safeOverlay){ctx.strokeStyle='rgba(255,255,255,.35)';ctx.lineWidth=2;ctx.strokeRect(pad,pad,w-pad*2,h-pad*2)}
  const msg=$('bnContrastMsg');if(msg)msg.innerHTML=`í…ìŠ¤íŠ¸ ëŒ€ë¹„: <b class="${cr>=4.5?'success':(cr>=3?'warn':'error')}">${cr.toFixed(2)}</b> (ê¶Œì¥ â‰¥ 4.5)`;
}
$('btnGenBanners').onclick=async()=>{
  const brand=($('b_name').value||'BRAND').trim();
  const title=$('bn_title').value||`${brand} ì˜¤ëŠ˜ì˜ í”„ë¡œëª¨ì…˜`; let sub=$('bn_sub').value||'ì§€ê¸ˆ ë°©ë¬¸/DM ì£¼ì„¸ìš”';
  const c1=$('bn_c1').value,c2=$('bn_c2').value; let tx=$('bn_tx').value||'#ffffff';
  const qrUrl=buildQR(); let wm=$('bn_wm').value.trim(); if(!wm&&brand) wm='@'+brand.replace(/\s+/g,'');
  const wmOn=$('bn_wm_on').value==='on',autoOn=$('auto_contrast').value==='on',safeOn=$('safe_overlay').value==='on',textBg=$('text_bg').value,offer=$('offer_badge').value;
  if(!sub.match(/%|1\+1|ì„ ë“±ë¡|ì„¸íŠ¸/i)&&offer){sub=sub+' Â· '+offer}
  const sizes=[]; if($('size_sq').checked)sizes.push([1080,1080,'sq']); if($('size_por').checked)sizes.push([1080,1350,'por']); if($('size_hd').checked)sizes.push([1920,1080,'hd']);
  const cv=$('cnv'),ctx=cv.getContext('2d'); const zip=new JSZip();
  for(const [W,H,tag] of sizes){for(let i=0;i<6;i++){const c=document.createElement('canvas');c.width=W;c.height=H;const cx=c.getContext('2d');
    drawBanner(cx,W,H,title,sub,c1,c2,tx,i,qrUrl,wm,wmOn,autoOn,safeOn,textBg,offer);
    const data=c.toDataURL('image/png').split(',')[1]; zip.file(`banner_${tag}_${i+1}.png`,data,{base64:true}); if(i===0&&tag==='sq'){ctx.drawImage(c,0,0,540,540)}
  }}
  const blob=await zip.generateAsync({type:'blob'}); saveAs(blob,'banners_pro.zip');
  window.__audit_offer=!!offer; window.__audit_wm=wmOn&&!!wm; window.__audit_qr=!!qrUrl;
}

// ===== Captions =====
const TEMPLATES={friendly:["ì˜¤ëŠ˜ë„ @{brand}! {product}ë¡œ {benefit} â˜•ï¸ #{hashtags}","ì‹œí—˜ê¸°ê°„ì—” {product}! {reason} ğŸ”¥ #{hashtags}","{brand} ì˜¤ëŠ˜ í•œì • {offer}. {call}","ì§‘ì¤‘ ëª¨ë“œ ON. {product}ë¡œ {benefit}! #{hashtags}"],
minimal:["{product}. {benefit}. #{hashtags}","{brand} â€” {tagline}. ì˜¤ëŠ˜ë„ ì°¨ë¶„í•˜ê²Œ.","{offer}. {call}","{product}: {reason}"],
energetic:["{product} í­ë°œ ì„¸ì¼! {offer} âš¡ï¸ ì§€ê¸ˆ {call}","ì§‘ì¤‘ë ¥ ì˜¬ë¦¬ê³  ì„±ì  ì—…! {reason} #{hashtags}","ì—ë„ˆì§€ ì¶©ì „ ì™„ë£Œ. {product}ë¡œ {benefit}!","ì˜¤ëŠ˜ ì•ˆ ì‚¬ë©´ ì†í•´ #{hashtags}"]};
const OFFERS={cafe:["ì•„ë©”ë¦¬ì¹´ë…¸ 1+1(ì˜¤ì „)","ì‹œì¦Œë¼ë–¼ 20%","ìŠ¤í„°ë”” 3ì‹œê°„ê¶Œ 10%","ë¦¬í•„ 500ì›","í•™ìƒì¦ ì œì‹œ 1,000ì› í• ì¸"],
              academy:["ì„ ë“±ë¡ 5%","ì¹œêµ¬ì¶”ì²œ 1ì£¼ ë¬´ë£Œ","ëª¨ì˜ê³ ì‚¬ ë‹¹ì¼ í• ì¸","ê³¼ëª©íŒ¨ìŠ¤ ë¬¶ìŒ 10%","ìƒë‹´ ì˜ˆì•½ ì‹œ êµ¿ì¦ˆ ì¦ì •"],
              handmade:["ì„¸íŠ¸ 10%","2+1 ë²ˆë“¤","ì‹ ìƒ ì²« 50ê°œ","ë¦¬ë·° í¬í† ì¿ í°","ì£¼ë§ íŒì—… 15%"]};
function pick(a){return a[Math.floor(Math.random()*a.length)]}
function tags(kws){const base=kws.split(',').map(s=>('#'+s.trim().replace(/\s+/g,''))).filter(Boolean);const common=['í•™ìƒ','ë¸Œëœë”©','ì¹´í˜','êµ¿ì¦ˆ','ê³µë¶€','ì‹œí—˜','ì§‘ì¤‘'].map(x=>'#'+x);return [...base.slice(0,4),...common.slice(0,4)].join(' ')}
$('btnGenCaps').onclick=()=>{
  const brand=($('b_name').value||'BRAND').trim(),tagline=($('b_slogan').value||'ìŠ¬ë¡œê±´').trim(),kws=$('cp_kw').value||'ì¹´í˜, ì§‘ì¤‘, ì‹œí—˜, í• ì¸',tone=$('cp_tone').value;
  const product=brand+' ì‹œê·¸ë‹ˆì²˜',benefit='ì§‘ì¤‘ ìœ ì§€',reason='ë¡±í…€ ì¹´í˜ì¸ìœ¼ë¡œ ì˜¤ë˜ ê°€ìš”',call='ë°©ë¬¸/DM ì£¼ì„¸ìš”',hs=tags(kws),offer=pick(OFFERS[$('offer_preset').value||'cafe']);
  const arr=[];for(let i=0;i<5;i++){const tpl=TEMPLATES[tone][i%TEMPLATES[tone].length];arr.push(tpl.replace(/{brand}/g,brand).replace(/{product}/g,product).replace(/{benefit}/g,benefit).replace(/{reason}/g,reason).replace(/{offer}/g,offer).replace(/{call}/g,call).replace(/{tagline}/g,tagline).replace(/{hashtags}/g,hs))}
  arr.push(`\n[ì˜¤í¼ ì‚¬ìš©] ${offer}`); $('cp_out').value=arr.join("\n\n"); window.__audit_offer=true;
}
$('btnOffers').onclick=()=>{const type=$('offer_preset').value||'cafe';const list=OFFERS[type];const p=Array.from({length:5},()=>pick(list));$('cp_out').value=($('cp_out').value?$('cp_out').value+"\n\n":"")+"[ì˜¤í¼ ì•„ì´ë””ì–´]\n"+p.map((x,i)=>`${i+1}. ${x}`).join("\n")}
$('btnCopyCaps').onclick=()=>{$('cp_out').select();document.execCommand('copy')}

// ===== A/B CSV =====
$('btnCSV').onclick=()=>{const name=$('ab_name').value||'campaign',a=$('ab_a').value||'A text',b=$('ab_b').value||'B text',today=fmtDate(new Date());
  const header='date,campaign,version,caption,clicks,impressions,ctr,conversions\n';
  const rows=[`${today},${name},A,"${a.replace(/"/g,'""')}",0,0,0,0`,`${today},${name},B,"${b.replace(/"/g,'""')}",0,0,0,0`].join('\n');
  const blob=new Blob([header+rows],{type:'text/csv;charset=utf-8'}); saveAs(blob,'ab.csv')
}

// ===== Calendar =====
function parseDate(s){const [y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d)}function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x}function wday(d){return d.getDay()}
$('btnCalCSV').onclick=()=>{const startStr=$('cal_start').value||fmtDate(new Date()),days=parseInt($('cal_days').value||'7',10),freq=$('cal_freq').value,time=$('cal_time').value,platform=$('cal_platform').value,start=parseDate(startStr);
  const header='date,time,platform,caption\n';const rows=[];for(let i=0;i<days;i++){const day=addDays(start,i),w=wday(day);let pass=false;if(freq==='daily')pass=true;if(freq==='3x'&&(w===1||w===3||w===5))pass=true;if(freq==='2x'&&(w===2||w===4))pass=true;if(!pass)continue;rows.push(`${fmtDate(day)},${time},${platform},`)}
  const blob=new Blob([header+rows.join('\n')],{type:'text/csv;charset=utf-8'}); saveAs(blob,'posting_calendar.csv'); window.__audit_cal=rows.length>=2
}

// ===== Audit =====
function updateAudit(){const c1=$('bn_c1').value,tx=$('bn_tx').value||'#fff',cr=contrast(c1,tx);$('audit_contrast').textContent=cr.toFixed(2)+(cr>=4.5?' âœ“':' âœ—');$('audit_wm').textContent=(window.__audit_wm?'OK âœ“':'ë¯¸ì„¤ì • âœ—');$('audit_qr').textContent=(window.__audit_qr?'OK âœ“':'ë¯¸ì„¤ì • âœ—');$('audit_offer').textContent=(window.__audit_offer?'OK âœ“':'ë¯¸í¬í•¨ âœ—');$('audit_cal').textContent=(window.__audit_cal?'OK âœ“':'ë¯¸ìƒì„± âœ—')}
$('btnAuditNow').onclick=updateAudit;

// ===== Tabs =====
function showTab(n){['panelBrand','panelBanners','panelCaptions','panelAB','panelCalendar','panelAudit'].forEach((p,i)=>i===n?show(p):hide(p))}
$('tabBrand').onclick=()=>showTab(0);$('tabBanners').onclick=()=>showTab(1);$('tabCaptions').onclick=()=>showTab(2);$('tabAB').onclick=()=>showTab(3);$('tabCalendar').onclick=()=>showTab(4);$('tabAudit').onclick=()=>{showTab(5);updateAudit()}

// init
updatePreview();
</script>
</body>
</html>
